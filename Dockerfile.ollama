# Dockerfile for Ollama service
FROM ollama/ollama:latest

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Create a directory for models
RUN mkdir -p /root/.ollama

# Expose Ollama port
EXPOSE 11434

# Create entrypoint script
RUN echo '#!/bin/bash\n\
    set -e\n\
    \n\
    echo "Starting Ollama server..."\n\
    ollama serve &\n\
    \n\
    # Wait for Ollama to be ready\n\
    echo "Waiting for Ollama to start..."\n\
    while ! curl -s http://localhost:11434/api/tags > /dev/null; do\n\
    echo "Waiting for Ollama to be ready..."\n\
    sleep 2\n\
    done\n\
    \n\
    echo "Ollama is ready, pulling model..."\n\
    ollama pull llama3.1:8b\n\
    \n\
    echo "Model pulled successfully, keeping server running..."\n\
    wait\n\
    ' > /entrypoint.sh && chmod +x /entrypoint.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags || exit 1

ENTRYPOINT ["/entrypoint.sh"]