# Supplier & Purchase Order Tools - API Contracts
# Feature: 001-mastra-assistant-tools
# Requirements: FR-015, FR-016, FR-017

tools:
  - name: listSuppliers
    description: "List all suppliers with performance metrics (lead time, order accuracy)"
    requirements: [FR-015]
    authorization:
      requiredPermission: VIEW_SUPPLIERS
      allowedRoles: [Admin, Manager, Staff, Viewer]
    
    input:
      schema:
        type: object
        properties:
          active:
            type: boolean
            description: "Filter by active status (null = all)"
            nullable: true
          sortBy:
            type: string
            enum: [name, leadTime, orderCount, accuracy]
            default: name
          sortOrder:
            type: string
            enum: [asc, desc]
            default: asc
          includeMetrics:
            type: boolean
            default: true
            description: "Include performance metrics (slower query)"
      
      examples:
        - name: "All active suppliers with metrics"
          value:
            active: true
            includeMetrics: true
        
        - name: "Fastest suppliers first"
          value:
            sortBy: leadTime
            sortOrder: asc
    
    output:
      success:
        schema:
          type: object
          properties:
            success: { type: boolean, const: true }
            suppliers:
              type: array
              items:
                type: object
                properties:
                  id: { type: string }
                  name: { type: string }
                  contactName: { type: string }
                  email: { type: string }
                  phone: { type: string }
                  leadTimeDays: { type: integer }
                  active: { type: boolean }
                  metrics:
                    type: object
                    nullable: true
                    properties:
                      totalOrders: { type: integer }
                      avgActualLeadTime: { type: number }
                      orderAccuracy: { type: number, description: "Percentage 0-100" }
                      lastOrderDate: { type: string, format: date, nullable: true }
            message: { type: string }
        
        example:
          success: true
          suppliers:
            - id: "sup_abc123"
              name: "Widgets R Us"
              contactName: "John Smith"
              email: "john@widgetsrus.com"
              phone: "+1-555-0100"
              leadTimeDays: 7
              active: true
              metrics:
                totalOrders: 45
                avgActualLeadTime: 6.8
                orderAccuracy: 94.5
                lastOrderDate: "2025-11-01"
            - id: "sup_xyz789"
              name: "Global Parts Co"
              contactName: "Jane Doe"
              email: "jane@globalparts.com"
              phone: "+1-555-0200"
              leadTimeDays: 14
              active: true
              metrics:
                totalOrders: 28
                avgActualLeadTime: 15.2
                orderAccuracy: 89.0
                lastOrderDate: "2025-10-28"
          message: "Found 2 active suppliers"
      
      errors:
        - code: INSUFFICIENT_PERMISSIONS
          status: 403
    
    sideEffects:
      - "Creates ToolExecutionLog entry"
      - "Read-only operation"
    
    performance:
      targetLatency:
        withMetrics: "< 2s"
        withoutMetrics: "< 500ms"
      cachingStrategy: "Cache metrics (1 hour TTL), refresh on PO completion"

  - name: createPurchaseOrder
    description: "Create a new purchase order to restock inventory from a supplier"
    requirements: [FR-016]
    authorization:
      requiredPermission: MANAGE_PURCHASE_ORDERS
      allowedRoles: [Admin, Manager]
    
    input:
      schema:
        type: object
        required: [supplierId, items]
        properties:
          supplierId:
            type: string
          items:
            type: array
            minItems: 1
            maxItems: 100
            items:
              type: object
              required: [productId, quantity, unitCost]
              properties:
                productId: { type: string }
                quantity: { type: integer, minimum: 1 }
                unitCost: { type: number, format: decimal, minimum: 0 }
          expectedDate:
            type: string
            format: date
            description: "Expected delivery date (auto-calculated if omitted)"
          tax:
            type: number
            format: decimal
            minimum: 0
            default: 0
          notes:
            type: string
            maxLength: 1000
          status:
            type: string
            enum: [DRAFT, SENT]
            default: SENT
      
      examples:
        - name: "Standard PO"
          value:
            supplierId: "sup_abc123"
            items:
              - productId: "prod_001"
                quantity: 100
                unitCost: 15.00
              - productId: "prod_002"
                quantity: 50
                unitCost: 22.50
            expectedDate: "2025-11-15"
            status: "SENT"
        
        - name: "Draft PO for review"
          value:
            supplierId: "sup_xyz789"
            items:
              - productId: "prod_100"
                quantity: 500
                unitCost: 5.00
            notes: "Bulk order - awaiting budget approval"
            status: "DRAFT"
    
    output:
      success:
        schema:
          type: object
          properties:
            success: { type: boolean, const: true }
            purchaseOrder:
              type: object
              properties:
                id: { type: string }
                poNumber: { type: string }
                supplier: { type: object }
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      product: { type: object }
                      quantity: { type: integer }
                      unitCost: { type: number }
                      subtotal: { type: number }
                subtotal: { type: number }
                tax: { type: number }
                total: { type: number }
                expectedDate: { type: string, format: date }
                status: { type: string }
                createdAt: { type: string, format: date-time }
            message: { type: string }
        
        example:
          success: true
          purchaseOrder:
            id: "po_new456"
            poNumber: "PO-20251103-00012"
            supplier: { id: "sup_abc123", name: "Widgets R Us" }
            items:
              - product: { id: "prod_001", sku: "SKU-001", name: "Widget A" }
                quantity: 100
                unitCost: 15.00
                subtotal: 1500.00
              - product: { id: "prod_002", sku: "SKU-002", name: "Widget B" }
                quantity: 50
                unitCost: 22.50
                subtotal: 1125.00
            subtotal: 2625.00
            tax: 0.00
            total: 2625.00
            expectedDate: "2025-11-15"
            status: "SENT"
            createdAt: "2025-11-03T16:30:00Z"
          message: "Purchase order PO-20251103-00012 created and sent to Widgets R Us. Expected delivery: Nov 15, 2025."
      
      errors:
        - code: SUPPLIER_NOT_FOUND
          status: 404
        - code: PRODUCT_NOT_FOUND
          status: 404
        - code: INACTIVE_SUPPLIER
          status: 400
          message: "Cannot create PO for inactive supplier"
        - code: INVALID_COST
          status: 400
          message: "Unit cost must be non-negative"
    
    sideEffects:
      - "Inserts PurchaseOrder and PurchaseOrderItem records"
      - "Generates unique poNumber with format PO-YYYYMMDD-XXXXX"
      - "Auto-calculates expectedDate if omitted (current date + supplier.leadTimeDays)"
      - "Sends email notification to supplier if status is SENT"
      - "Creates ToolExecutionLog entry"
    
    performance:
      targetLatency: "< 1.5s"
      transactionIsolation: "READ COMMITTED"

  - name: receivePurchaseOrder
    description: "Mark a purchase order as received (full or partial) and update product inventory"
    requirements: [FR-017]
    authorization:
      requiredPermission: MANAGE_PURCHASE_ORDERS
      allowedRoles: [Admin, Manager, Staff]
    
    input:
      schema:
        type: object
        required: [purchaseOrderId, receivedItems]
        properties:
          purchaseOrderId:
            type: string
          receivedItems:
            type: array
            minItems: 1
            items:
              type: object
              required: [purchaseOrderItemId, receivedQuantity]
              properties:
                purchaseOrderItemId: { type: string }
                receivedQuantity: { type: integer, minimum: 0 }
          notes:
            type: string
            maxLength: 500
            description: "Receiving notes (e.g., damaged items, discrepancies)"
      
      examples:
        - name: "Full receipt"
          value:
            purchaseOrderId: "po_456"
            receivedItems:
              - purchaseOrderItemId: "poi_001"
                receivedQuantity: 100
              - purchaseOrderItemId: "poi_002"
                receivedQuantity: 50
        
        - name: "Partial receipt with notes"
          value:
            purchaseOrderId: "po_789"
            receivedItems:
              - purchaseOrderItemId: "poi_003"
                receivedQuantity: 80
            notes: "Received 80 of 100 units. Remaining 20 units backordered."
    
    output:
      success:
        schema:
          type: object
          properties:
            success: { type: boolean, const: true }
            purchaseOrder:
              type: object
              properties:
                id: { type: string }
                poNumber: { type: string }
                status: { type: string, enum: [PARTIALLY_RECEIVED, RECEIVED] }
                receivedAt: { type: string, format: date-time, nullable: true }
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      product: { type: object }
                      orderedQty: { type: integer }
                      receivedQty: { type: integer }
                      remainingQty: { type: integer }
            inventoryUpdates:
              type: array
              items:
                type: object
                properties:
                  productId: { type: string }
                  productName: { type: string }
                  previousQty: { type: integer }
                  receivedQty: { type: integer }
                  newQty: { type: integer }
            message: { type: string }
        
        example:
          success: true
          purchaseOrder:
            id: "po_456"
            poNumber: "PO-20251103-00012"
            status: "RECEIVED"
            receivedAt: "2025-11-03T17:00:00Z"
            items:
              - product: { id: "prod_001", name: "Widget A" }
                orderedQty: 100
                receivedQty: 100
                remainingQty: 0
              - product: { id: "prod_002", name: "Widget B" }
                orderedQty: 50
                receivedQty: 50
                remainingQty: 0
          inventoryUpdates:
            - productId: "prod_001"
              productName: "Widget A"
              previousQty: 25
              receivedQty: 100
              newQty: 125
            - productId: "prod_002"
              productName: "Widget B"
              previousQty: 10
              receivedQty: 50
              newQty: 60
          message: "Purchase order PO-20251103-00012 fully received. Inventory updated for 2 products."
      
      errors:
        - code: PO_NOT_FOUND
          status: 404
        - code: INVALID_PO_STATUS
          status: 400
          message: "Cannot receive PO with status DRAFT or CANCELLED"
        - code: ITEM_NOT_IN_PO
          status: 400
          message: "Purchase order item 'poi_999' not found in this PO"
        - code: QUANTITY_EXCEEDS_ORDERED
          status: 400
          message: "Received quantity (120) exceeds ordered quantity (100)"
        - code: ALREADY_FULLY_RECEIVED
          status: 400
          message: "All items in this PO have already been fully received"
    
    sideEffects:
      - "Updates PurchaseOrderItem.receivedQty for specified items"
      - "Updates PurchaseOrder.status (PARTIALLY_RECEIVED or RECEIVED)"
      - "Sets PurchaseOrder.receivedAt when fully received"
      - "Increments Product.availableQuantity for each received item"
      - "Creates ToolExecutionLog entry"
      - "May trigger reorder alert cancellations if stock is replenished"
    
    performance:
      targetLatency: "< 1.5s"
      databaseOperations: "1 PO update + N product updates (transaction)"
      transactionIsolation: "SERIALIZABLE"

# Performance Benchmarks
performance:
  listSuppliers:
    withMetrics: "< 2s"
    withoutMetrics: "< 500ms"
  createPurchaseOrder: "< 1.5s for 10-item PO"
  receivePurchaseOrder: "< 1.5s for full receipt"

# Testing Requirements
testing:
  unitTests:
    - "Expected date auto-calculation based on lead time"
    - "Partial vs full receipt status determination"
    - "Quantity validation (received ≤ ordered)"
    - "Supplier performance metrics calculation"
  
  integrationTests:
    - "Transaction rollback on inventory update failure"
    - "PO status transitions (SENT → PARTIALLY_RECEIVED → RECEIVED)"
    - "Concurrent receiving operations"
    - "Email notification sending"
  
  e2eTests:
    - "Complete PO lifecycle (create → receive → inventory update)"
    - "Partial receipt with multiple receiving sessions"
    - "Supplier performance metrics dashboard"

# Changelog
changelog:
  - version: 1.0.0
    date: 2025-11-03
    changes: "Initial contract definition for supplier and PO tools"
