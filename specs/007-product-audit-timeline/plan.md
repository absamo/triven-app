# Implementation Plan: Product Audit Timeline

**Branch**: `007-product-audit-timeline` | **Date**: 2025-11-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-product-audit-timeline/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow defined in `.github/prompts/speckit.plan.prompt.md`.

## Summary

Implement a generic audit logging system with timeline UI for tracking product changes (creation, modification, deletion). The system captures who made what changes and when, storing field-level before/after values. Users access audit history through a right-side drawer on the products page showing events in reverse chronological order with lazy loading (first 20 events, scroll for more). The architecture is designed to support future expansion to other entities (orders, customers, suppliers) through generic `entityType` and `entityId` fields.

**Technical Approach**: Prisma middleware or service layer interceptors capture changes at the ORM level. Audit data stored in separate tables (`AuditEvent`, `FieldChange`) that survive entity deletion. Mantine Drawer component for UI with infinite scroll using React Router loaders for data fetching. No real-time updates required - simple REST API fetch on drawer open.

## Technical Context

**Language/Version**: TypeScript 5.8+, Node.js 20+, Bun runtime  
**Primary Dependencies**: React 19.1.1, React Router 7.8.2, Mantine UI 8.2.7, Prisma ORM, Better Auth 1.3.3, Zod 4.1.0, react-i18next 15.5.3  
**Storage**: PostgreSQL (existing Prisma schema with Product, User entities)  
**Testing**: Vitest for unit/integration tests, Testing Library for React component tests  
**Target Platform**: Web application (React Router v7 full-stack)  
**Project Type**: Web (frontend + backend in unified React Router app)  
**Performance Goals**: <2s audit history load time, <500ms API response p95, handle 1000+ audit events without UI freezing  
**Constraints**: <1KB per audit event storage, audit data must survive product deletion, lazy loading after first 20 events  
**Scale/Scope**: Generic audit system architecture supporting future entity types (orders, customers, suppliers), initial implementation for products only

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Service-Oriented Architecture
- [x] Feature implemented as standalone service with clear boundaries - Audit service with dedicated models and API endpoints
- [x] Service has well-defined API interfaces (documented in contracts/) - Will define audit history retrieval API
- [x] Service can be tested independently - Audit capture and retrieval can be tested in isolation

### API-First Development
- [x] OpenAPI 3.0+ specifications created before implementation - Will create in Phase 1
- [x] Request/response schemas defined with Zod validation - Will define audit event schemas
- [x] API contracts reviewed and approved - Will be part of Phase 1 deliverables

### Test-First Development (NON-NEGOTIABLE)
- [x] Test strategy documented (unit, integration, E2E) - Unit tests for audit service, integration tests for API endpoints, E2E tests for drawer interaction
- [x] Tests will be written BEFORE implementation code - TDD workflow will be followed
- [x] Red-Green-Refactor cycle will be followed - Standard TDD practice
- [x] All tests must pass before merge - CI/CD requirement

### Real-Time Communication (if applicable)
- [x] Real-time updates NOT required per spec - Audit history loaded on-demand when drawer opens
- [x] Manual refresh acceptable - No SSE needed for this feature
- [x] No polling mechanism - Simple API fetch on drawer open

**Decision**: This feature does NOT require real-time communication. Audit history is static historical data that changes infrequently (only when products are modified). Users open the drawer on-demand, and the data is fetched once. Future enhancement could add SSE for live updates during bulk operations, but initial implementation uses simple REST API.

### Data Integrity and Audit Trails (if applicable)
- [x] Audit logging planned for business-critical operations - This IS the audit logging feature
- [x] Who/What/When captured (userId, action, timestamp) - Core requirement from spec FR-002
- [x] Change tracking with before/after states - Field-level tracking per FR-009
- [x] Immutable audit records - Audit entries are read-only per AS-007

### AI Integration (if applicable)
- [x] N/A - No AI features in this implementation

### Performance and Caching
- [x] Query optimization strategy defined (select, indexes) - Will index on productId, timestamp; select only needed fields
- [x] Pagination implemented for large result sets (20-100 items) - Lazy loading first 20 events per FR-013
- [x] Caching strategy documented for static/frequently-accessed data - Audit history is immutable once created, can cache aggressively
- [x] Performance targets documented (<500ms p95 API, <100ms DB queries) - Target <2s load time per SC-001, <500ms API per constitution

### Development Tooling & Quality Assurance
- [x] Context7 MCP used to fetch latest documentation for frameworks/libraries before implementation - Will query Prisma docs for schema patterns, Mantine docs for Drawer component, React Router docs for data loading
- [x] Implementation follows patterns from fetched documentation - Standard practice
- [x] Chrome DevTools MCP testing plan documented for UI verification - Will test drawer open/close, timeline scroll, event expansion
- [x] Test credentials documented for authentication testing (if applicable) - Use admin@flowtech.com / password123 per copilot-instructions
- [x] MCP workflow integrated: Pre-implementation docs → Implementation → Post-implementation testing - Standard workflow

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
app/
├── routes/
│   └── api/
│       └── audit.products.$productId.ts     # GET audit history endpoint
├── services/
│   ├── audit.server.ts                      # Audit capture service
│   └── audit-query.server.ts                # Audit retrieval service
├── components/
│   ├── ProductAuditDrawer/
│   │   ├── ProductAuditDrawer.tsx          # Main drawer component
│   │   ├── AuditTimeline.tsx               # Timeline list view
│   │   ├── AuditEvent.tsx                  # Single event card
│   │   └── FieldChangeDetail.tsx           # Field comparison view
│   └── ProductsList/
│       └── ProductAuditButton.tsx          # Button to trigger drawer
├── hooks/
│   └── useAuditHistory.ts                  # Hook for fetching audit data
└── test/
    ├── services/
    │   ├── audit.server.test.ts            # Unit tests for audit capture
    │   └── audit-query.server.test.ts      # Unit tests for retrieval
    ├── routes/
    │   └── api.audit.test.ts               # Integration tests for API
    └── components/
        └── ProductAuditDrawer.test.tsx     # Component tests

prisma/
├── schema.prisma                            # Add AuditEvent, FieldChange models
└── migrations/
    └── [timestamp]_add_audit_tables/        # Migration for audit schema
```

**Structure Decision**: React Router v7 full-stack web application. Frontend components and backend API routes coexist in `app/` directory. Audit service is generic and reusable for future entity types through `entityType` and `entityId` fields. Prisma schema extended with audit models that are independent of product lifecycle (survive deletion).

## Complexity Tracking

**No violations detected**. All constitutional principles are satisfied:

- ✅ Service-Oriented Architecture: Standalone audit service
- ✅ API-First Development: OpenAPI spec created before implementation
- ✅ Test-First Development: TDD workflow documented in quickstart.md
- ✅ No Real-Time Communication: Feature uses simple REST API (audit history is static)
- ✅ Data Integrity: Immutable audit trail with complete context
- ✅ Performance: Indexed queries, cursor pagination, <500ms target
- ✅ Development Tooling: MCP integration documented for pre/post implementation
