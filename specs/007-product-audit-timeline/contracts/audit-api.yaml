openapi: 3.0.3
info:
  title: Product Audit Timeline API
  description: |
    API for retrieving audit history of product changes. Tracks creation, modification, 
    and deletion events with field-level change details.
  version: 1.0.0
  contact:
    name: Triven App API Support

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://app.triven.com
    description: Production server

tags:
  - name: audit
    description: Audit trail operations

paths:
  /api/audit/products/{productId}:
    get:
      summary: Get audit history for a product
      description: |
        Retrieves the audit trail for a specific product, showing all creation, 
        modification, and deletion events in reverse chronological order. 
        Supports cursor-based pagination for efficient loading of large histories.
      operationId: getProductAuditHistory
      tags:
        - audit
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: path
          required: true
          description: Unique identifier of the product
          schema:
            type: string
            format: cuid
            example: clx456def
        - name: cursor
          in: query
          required: false
          description: |
            Cursor for pagination. Use the `nextCursor` value from the previous 
            response to load the next page of events.
          schema:
            type: string
            format: cuid
            example: clx789ghi
        - name: limit
          in: query
          required: false
          description: |
            Maximum number of events to return per page. Default is 20, max is 100.
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: startDate
          in: query
          required: false
          description: Filter events after this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
            example: "2025-11-01T00:00:00Z"
        - name: endDate
          in: query
          required: false
          description: Filter events before this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
            example: "2025-11-14T23:59:59Z"
        - name: userId
          in: query
          required: false
          description: Filter events by user who performed the action
          schema:
            type: string
            format: cuid
            example: user123
        - name: eventType
          in: query
          required: false
          description: Filter by event type
          schema:
            type: string
            enum: [create, update, delete]
            example: update
      responses:
        '200':
          description: Successful response with audit events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditHistoryResponse'
              examples:
                withEvents:
                  summary: Product with audit history
                  value:
                    items:
                      - id: clx999jkl
                        entityType: product
                        entityId: clx456def
                        eventType: update
                        userId: user456
                        userName: Jane Smith
                        timestamp: "2025-11-14T14:45:00Z"
                        changedFields: [sellingPrice, quantity]
                        beforeSnapshot:
                          name: Wireless Mouse
                          sku: WM-001
                          sellingPrice: 29.99
                          quantity: 100
                        afterSnapshot:
                          name: Wireless Mouse
                          sku: WM-001
                          sellingPrice: 24.99
                          quantity: 85
                      - id: clx123abc
                        entityType: product
                        entityId: clx456def
                        eventType: create
                        userId: user123
                        userName: John Doe
                        timestamp: "2025-11-14T10:30:00Z"
                        changedFields: []
                        beforeSnapshot: null
                        afterSnapshot:
                          name: Wireless Mouse
                          sku: WM-001
                          sellingPrice: 29.99
                          quantity: 100
                    nextCursor: clx123abc
                    hasMore: false
                    total: 2
                noEvents:
                  summary: Product with no audit history
                  value:
                    items: []
                    nextCursor: null
                    hasMore: false
                    total: 0
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Invalid request
                message: "productId must be a valid CUID"
                statusCode: 400
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Authentication required to access audit history
                statusCode: 401
        '403':
          description: Forbidden - user does not have access to this product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Forbidden
                message: You do not have permission to view this product's audit history
                statusCode: 403
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Product with id 'clx456def' not found
                statusCode: 404
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Internal Server Error
                message: An unexpected error occurred while fetching audit history
                statusCode: 500

components:
  schemas:
    AuditHistoryResponse:
      type: object
      required:
        - items
        - hasMore
        - total
      properties:
        items:
          type: array
          description: List of audit events in reverse chronological order
          items:
            $ref: '#/components/schemas/AuditEvent'
        nextCursor:
          type: string
          format: cuid
          nullable: true
          description: |
            Cursor to use for fetching the next page of events. 
            Null if no more events exist.
          example: clx789ghi
        hasMore:
          type: boolean
          description: Indicates if more events are available after this page
          example: true
        total:
          type: integer
          description: Total number of audit events for this product
          example: 42

    AuditEvent:
      type: object
      required:
        - id
        - entityType
        - entityId
        - eventType
        - userId
        - userName
        - timestamp
        - changedFields
      properties:
        id:
          type: string
          format: cuid
          description: Unique identifier for the audit event
          example: clx999jkl
        entityType:
          type: string
          description: Type of entity being tracked
          enum: [product]
          example: product
        entityId:
          type: string
          format: cuid
          description: Unique identifier of the tracked entity
          example: clx456def
        eventType:
          type: string
          description: Type of change event
          enum: [create, update, delete]
          example: update
        userId:
          type: string
          format: cuid
          description: Unique identifier of the user who performed the action
          example: user456
        userName:
          type: string
          description: Name of the user who performed the action (preserved at time of change)
          example: Jane Smith
        timestamp:
          type: string
          format: date-time
          description: When the action occurred (ISO 8601 format)
          example: "2025-11-14T14:45:00Z"
        changedFields:
          type: array
          description: |
            List of field names that changed. Empty for create and delete events.
            For update events, contains at least one field name.
          items:
            type: string
            example: sellingPrice
          example: [sellingPrice, quantity]
        beforeSnapshot:
          type: object
          nullable: true
          description: |
            Full entity state before the change. Null for create events.
            Contains all fields of the entity at the time of the previous state.
          additionalProperties: true
          example:
            name: Wireless Mouse
            sku: WM-001
            sellingPrice: 29.99
            quantity: 100
        afterSnapshot:
          type: object
          nullable: true
          description: |
            Full entity state after the change. Null for delete events.
            Contains all fields of the entity in its new state.
          additionalProperties: true
          example:
            name: Wireless Mouse
            sku: WM-001
            sellingPrice: 24.99
            quantity: 85

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
          description: Error type or category
          example: Bad Request
        message:
          type: string
          description: Human-readable error message
          example: Invalid productId parameter
        statusCode:
          type: integer
          description: HTTP status code
          example: 400
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Authentication token from Better Auth session. Include the session 
        token in the Authorization header as "Bearer <token>".

security:
  - bearerAuth: []
